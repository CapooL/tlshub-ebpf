# TLSHub eBPF 设计文档

## 1. 概述

TLSHub eBPF 是一个基于 eBPF (Extended Berkeley Packet Filter) 技术的高性能网络流量捕获和分析工具。该模块专为 TLSHub 项目设计，提供内核级的数据包捕获、TLS 流量识别和事件拦截功能。

### 1.1 设计目标

- **高性能**: 利用 eBPF 在内核空间处理数据包，避免用户态/内核态切换开销
- **低侵入**: 无需修改内核代码，通过 eBPF 安全地扩展内核功能
- **灵活性**: 支持动态配置过滤规则，可在运行时调整监控策略
- **可扩展**: 模块化设计，便于添加新功能和协议支持

### 1.2 核心功能

1. **数据包捕获**: 基于 XDP 和 TC 实现双向流量捕获
2. **TLS 流量识别**: 自动识别 TLS 握手包，支持常见 TLS 端口
3. **事件上报**: 通过 perf buffer 高效传递事件到用户空间
4. **流量统计**: 实时统计接收/发送的数据包和字节数
5. **端口过滤**: 支持按端口过滤流量，减少不必要的开销

## 2. 系统架构

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────┐
│                   用户空间 (User Space)                │
├─────────────────────────────────────────────────────┤
│  tlshub_user.c - 用户空间主程序                        │
│  ├─ eBPF 程序加载器                                   │
│  ├─ 事件监听器 (perf buffer)                         │
│  ├─ 命令行接口                                        │
│  └─ 配置管理                                          │
└─────────────────────────────────────────────────────┘
                        ↕ (perf buffer)
┌─────────────────────────────────────────────────────┐
│                   内核空间 (Kernel Space)              │
├─────────────────────────────────────────────────────┤
│  tlshub_kern.c - eBPF 内核程序                        │
│  ├─ XDP 程序 (入向流量处理)                           │
│  ├─ TC 程序 (出向流量处理)                            │
│  ├─ BPF Maps (数据存储和通信)                         │
│  │  ├─ events (perf event array)                   │
│  │  ├─ stats_map (统计信息)                         │
│  │  └─ filter_ports (端口过滤配置)                  │
│  └─ 数据包解析和处理逻辑                              │
└─────────────────────────────────────────────────────┘
                        ↕
┌─────────────────────────────────────────────────────┐
│                   网络接口 (Network Interface)        │
│                   (eth0, wlan0, etc.)               │
└─────────────────────────────────────────────────────┘
```

### 2.2 数据流

1. **入向流量** (Ingress):
   ```
   网络接口 → XDP Hook → 数据包解析 → 过滤判断 → 事件生成 → Perf Buffer → 用户空间
   ```

2. **出向流量** (Egress):
   ```
   网络接口 → TC Hook → 数据包解析 → 过滤判断 → 事件生成 → Perf Buffer → 用户空间
   ```

## 3. 核心组件详解

### 3.1 eBPF 内核程序 (tlshub_kern.c)

#### 3.1.1 XDP 程序

- **挂载点**: XDP (eXpress Data Path)
- **执行时机**: 数据包到达网卡驱动后，内核协议栈处理之前
- **优势**: 最早拦截点，性能最优
- **功能**:
  - 解析以太网帧、IP 头部、TCP 头部
  - 提取源/目的地址和端口信息
  - 识别 TLS 握手包 (检测 0x16 0x03 特征)
  - 复制部分载荷数据
  - 更新统计信息
  - 通过 perf buffer 发送事件

#### 3.1.2 TC 程序

- **挂载点**: TC (Traffic Control)
- **执行时机**: 数据包从内核协议栈发出时
- **功能**: 与 XDP 类似，处理出向流量

#### 3.1.3 BPF Maps

1. **events** (BPF_MAP_TYPE_PERF_EVENT_ARRAY)
   - 用途: 向用户空间传递事件
   - 特点: 高效的无锁环形缓冲区

2. **stats_map** (BPF_MAP_TYPE_PERCPU_ARRAY)
   - 用途: 存储每个 CPU 的统计信息
   - 大小: 1 个条目
   - 特点: Per-CPU 设计避免锁竞争

3. **filter_ports** (BPF_MAP_TYPE_HASH)
   - 用途: 存储端口过滤规则
   - 最大条目: 1024
   - Key: 端口号 (__u32)
   - Value: 启用标志 (__u32)

### 3.2 用户空间程序 (tlshub_user.c)

#### 3.2.1 主要功能

1. **eBPF 程序加载**
   - 使用 libbpf 库加载 .o 文件
   - 附加 XDP 程序到指定网络接口
   - 获取 BPF maps 的文件描述符

2. **事件监听**
   - 创建 perf buffer
   - 注册事件处理回调函数
   - 轮询并处理事件

3. **配置管理**
   - 解析命令行参数
   - 设置端口过滤规则
   - 动态更新 BPF maps

4. **统计信息展示**
   - 定期查询统计 map
   - 格式化输出流量统计

#### 3.2.2 命令行接口

```
用法: tlshub [选项]
选项:
  -i <接口名>    指定网络接口 (必需)
  -p <端口>      添加端口过滤 (可多次使用)
  -h             显示帮助信息
```

### 3.3 共享数据结构 (tlshub_common.h)

定义内核空间和用户空间共享的数据结构：

- `event_type`: 事件类型枚举
- `packet_direction`: 数据包方向枚举
- `packet_info`: 数据包信息结构
- `event_data`: 事件数据结构
- `stats_info`: 统计信息结构

## 4. 关键技术

### 4.1 eBPF 技术

eBPF (Extended Berkeley Packet Filter) 是 Linux 内核的一项革命性技术：

- **安全性**: 通过验证器确保代码安全，不会导致内核崩溃
- **高效性**: 使用 JIT 编译器将 eBPF 字节码编译为本地机器码
- **灵活性**: 无需修改内核或加载内核模块

### 4.2 XDP (eXpress Data Path)

XDP 是 Linux 内核的高性能数据包处理框架：

- **零拷贝**: 直接在驱动层处理数据包
- **可编程**: 通过 eBPF 实现灵活的包处理逻辑
- **高性能**: 可达到接近线速的处理能力

### 4.3 Perf Buffer

用于内核空间和用户空间的高效数据传递：

- **无锁设计**: Per-CPU 环形缓冲区
- **批量处理**: 支持批量读取事件
- **低延迟**: 典型延迟在微秒级别

## 5. 性能优化

### 5.1 内核空间优化

1. **Per-CPU Maps**: 避免 CPU 间的锁竞争
2. **内联函数**: 使用 `__always_inline` 减少函数调用开销
3. **早期过滤**: 尽早丢弃不关注的数据包
4. **有限载荷复制**: 只复制前 512 字节的载荷

### 5.2 用户空间优化

1. **批量事件处理**: perf buffer 支持批量读取
2. **非阻塞轮询**: 避免阻塞主循环
3. **最小化系统调用**: 减少 bpf_map_lookup_elem 调用频率

## 6. 安全考虑

### 6.1 eBPF 验证

- eBPF 验证器确保程序不会访问非法内存
- 限制指令数量，防止无限循环
- 验证所有内存访问边界

### 6.2 权限控制

- 加载 eBPF 程序需要 CAP_BPF 或 CAP_SYS_ADMIN 能力
- 用户程序需要 root 权限运行

### 6.3 数据安全

- 只捕获部分载荷数据 (前 512 字节)
- 不存储完整数据包内容
- 用户需自行处理敏感数据

## 7. 扩展性

### 7.1 支持新协议

在 `tlshub_kern.c` 中添加新的协议解析函数：

```c
static __always_inline int parse_new_protocol(...) {
    // 协议解析逻辑
}
```

### 7.2 添加新事件类型

1. 在 `tlshub_common.h` 中定义新事件类型
2. 在内核程序中生成新事件
3. 在用户程序中处理新事件

### 7.3 新的 Hook 点

可以添加更多 eBPF 程序类型：

- Socket filter
- Cgroup skb
- Tracepoints
- Kprobes/Uprobes

## 8. 限制和权衡

### 8.1 当前限制

1. **协议支持**: 当前只支持 IPv4 和 TCP
2. **载荷大小**: 最多复制 512 字节载荷
3. **事件丢失**: 高流量下可能丢失事件
4. **接口类型**: XDP SKB 模式可能性能较低

### 8.2 设计权衡

1. **性能 vs 完整性**: 不捕获完整数据包以提高性能
2. **灵活性 vs 复杂性**: 保持简单的过滤规则
3. **实时性 vs 准确性**: 采用批量处理可能引入少许延迟

## 9. 未来改进

### 9.1 短期改进

- [ ] 支持 IPv6
- [ ] 支持 UDP 协议
- [ ] 添加更多统计指标
- [ ] 实现配置文件支持

### 9.2 长期规划

- [ ] 深度包检测 (DPI)
- [ ] 流量分类和识别
- [ ] 与 tlshub 内核模块集成
- [ ] 支持分布式部署
- [ ] Web 可视化界面

## 10. 参考资料

- [BPF and XDP Reference Guide](https://docs.cilium.io/en/stable/bpf/)
- [libbpf Documentation](https://libbpf.readthedocs.io/)
- [Linux Kernel BPF Documentation](https://www.kernel.org/doc/html/latest/bpf/)
- [XDP Tutorial](https://github.com/xdp-project/xdp-tutorial)
